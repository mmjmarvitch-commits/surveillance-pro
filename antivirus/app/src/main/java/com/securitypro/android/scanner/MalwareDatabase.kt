package com.securitypro.android.scanner

import com.securitypro.android.data.ThreatLevel

object MalwareDatabase {
    
    // ══════════════════════════════════════════════════════════════════════════
    // MALWARES CONNUS - Trojans, RATs, Banking Malware
    // ══════════════════════════════════════════════════════════════════════════
    val KNOWN_MALWARE = setOf(
        // Android Trojans
        "com.android.systemservice", "com.android.provision.confirm",
        "com.android.henbox", "com.mobistartapp", "com.android.tencent",
        "com.android.google.update", "com.system.service.zdsgt",
        "com.googleapi.updateservice", "com.android.vending.billing",
        "com.android.locker.master", "com.system.update.loader",
        // Banking Trojans
        "com.tencent.qqpimsecure", "com.android.bankbot", "com.android.cerberus",
        "com.android.anubis", "com.android.hydra", "com.android.eventbot",
        "com.android.gustuff", "com.android.medusa", "com.android.sova",
        "com.android.sharkbot", "com.android.teabot", "com.android.flubot",
        // RATs (Remote Access Trojans)
        "com.android.ahmyth", "com.android.spynote", "com.android.dendroid",
        "com.android.androrat", "com.android.droidjack", "com.android.omnirat",
        "com.android.sandrorat", "com.android.darkcomet", "com.android.ghostctrl",
        // Ransomware
        "com.android.simplocker", "com.android.lockerpin", "com.android.koler",
        "com.android.svpeng", "com.android.doublelocker", "com.android.wannalocker",
        // Rootkits & Exploits
        "com.android.gingermaster", "com.android.droidkungfu", "com.android.basebridge",
        "com.android.jifake", "com.android.geinimi", "com.android.golddream",
        // Fake System Apps
        "com.android.system.manager", "com.android.systemui.overlay",
        "com.android.providers.media.module", "com.android.internal.backup",
        "com.google.android.gms.update", "com.google.android.update.manager"
    )
    
    // ══════════════════════════════════════════════════════════════════════════
    // SPYWARES - Applications d'espionnage commerciales et malveillantes
    // ══════════════════════════════════════════════════════════════════════════
    val KNOWN_SPYWARE = setOf(
        // Spywares commerciaux majeurs
        "com.mspy", "mspy", "com.flexispy", "flexispy", "com.spyera", "spyera",
        "com.thetruthspy", "thetruthspy", "com.cocospy", "cocospy",
        "com.spyic", "spyic", "com.minspy", "minspy", "com.spyzie", "spyzie",
        "com.hoverwatch", "hoverwatch", "com.eyezy", "eyezy",
        "com.umobix", "umobix", "com.clevguard", "clevguard",
        "com.xnspy", "xnspy", "com.spyfone", "spyfone",
        "com.phonespector", "phonespector", "com.highstermobile", "highstermobile",
        // Spywares supplémentaires
        "com.ikeymonitor", "ikeymonitor", "com.webwatcher", "webwatcher",
        "com.mobilespy", "mobilespy", "com.spymaster", "spymaster",
        "com.spyphone", "spyphone", "com.cellspy", "cellspy",
        "com.phonetracker", "phonetracker", "com.guestspy", "guestspy",
        "com.copy9", "copy9", "com.spytoapp", "spytoapp",
        "com.spylix", "spylix", "com.kidsguard", "kidsguard",
        "com.pctatletale", "pctatletale", "com.spyine", "spyine",
        "com.neatspy", "neatspy", "com.spyier", "spyier",
        "com.fonemonitor", "fonemonitor", "com.teensafe", "teensafe",
        "com.spyhuman", "spyhuman", "com.auto.forward", "autoforward",
        "com.ddifi", "ddifi", "com.appspy", "appspy",
        "com.letmespy", "letmespy", "com.thespyapp", "thespyapp",
        "com.phonesheriff", "phonesheriff", "com.mobistealth", "mobistealth",
        "com.spybubble", "spybubble", "com.stealthgenie", "stealthgenie",
        // Stalkerware
        "com.reptilicus", "reptilicus", "com.cerberusapp", "cerberus",
        "com.trackview", "trackview", "com.familylink.spy", "familylinkspy",
        "com.wheres.my.droid", "wheresmydroid"
    )
    
    // ══════════════════════════════════════════════════════════════════════════
    // FAUX CONTRÔLES PARENTAUX - Apps déguisées en contrôle parental
    // ══════════════════════════════════════════════════════════════════════════
    val FAKE_PARENTAL_CONTROLS = setOf(
        // Apps qui se font passer pour du contrôle parental mais sont des spywares
        "com.parentalcontrol.spy", "com.family.tracker.hidden",
        "com.kids.safety.monitor", "com.child.tracker.stealth",
        "com.parental.monitor.pro", "com.family.spy.tracker",
        "com.kidcontrol.hidden", "com.safekids.spy",
        "com.parentspy", "com.familyspy", "com.kidsspy",
        "com.childmonitor.hidden", "com.parentmonitor.stealth",
        // Vrais spywares déguisés
        "com.kidsguard.pro", "kidsguardpro", "com.familyorbit", "familyorbit",
        "com.spyzie.parental", "com.cocospy.family", "com.mspy.parental",
        "com.clevguard.family", "com.parentalcontrol.xnspy",
        // Apps avec noms trompeurs
        "com.system.service", "com.android.service.helper",
        "com.phone.backup.service", "com.data.sync.service",
        "com.battery.optimizer.pro", "com.memory.cleaner.service",
        "com.wifi.manager.service", "com.network.monitor.service"
    )
    
    // ══════════════════════════════════════════════════════════════════════════
    // ADWARES ET PUP (Potentially Unwanted Programs)
    // ══════════════════════════════════════════════════════════════════════════
    val KNOWN_ADWARE = setOf(
        "com.android.adservice", "com.adcolony.sdk", "com.startapp.sdk",
        "com.airpush", "com.leadbolt", "com.revmob", "com.tapjoy",
        "com.millennialmedia", "com.mopub", "com.inmobi",
        "com.android.hiddad", "com.android.ewind", "com.android.guerrilla",
        "com.android.judy", "com.android.ztorg", "com.android.dresscode"
    )
    
    // ══════════════════════════════════════════════════════════════════════════
    // PATTERNS SUSPECTS - Regex pour détecter les noms de packages malveillants
    // ══════════════════════════════════════════════════════════════════════════
    val SUSPICIOUS_PATTERNS = listOf(
        // Mots-clés d'espionnage
        Regex(".*\\.spy.*", RegexOption.IGNORE_CASE),
        Regex(".*spy[a-z]*\\..*", RegexOption.IGNORE_CASE),
        Regex(".*\\.track(er)?.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.monitor.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.stealth.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.hidden.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.invisible.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.keylog.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.hack.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.malware.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.trojan.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.rat\\..*", RegexOption.IGNORE_CASE),
        Regex(".*\\.backdoor.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.rootkit.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.exploit.*", RegexOption.IGNORE_CASE),
        // Faux services système
        Regex(".*\\.system\\.service[0-9]*", RegexOption.IGNORE_CASE),
        Regex(".*\\.android\\.system[0-9]+.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.google\\.service[0-9]+.*", RegexOption.IGNORE_CASE),
        // Noms génériques suspects
        Regex(".*\\.update\\.service.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.sync\\.service.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.backup\\.hidden.*", RegexOption.IGNORE_CASE),
        // Stalkerware patterns
        Regex(".*stalk.*", RegexOption.IGNORE_CASE),
        Regex(".*snoop.*", RegexOption.IGNORE_CASE),
        Regex(".*watch(er)?.*secret.*", RegexOption.IGNORE_CASE),
        Regex(".*secret.*watch.*", RegexOption.IGNORE_CASE),
        // Scripts et injections
        Regex(".*\\.inject.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.hook.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.xposed.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.frida.*", RegexOption.IGNORE_CASE),
        Regex(".*\\.magisk\\.hide.*", RegexOption.IGNORE_CASE)
    )
    
    // ══════════════════════════════════════════════════════════════════════════
    // PERMISSIONS DANGEREUSES - Classées par niveau de risque
    // ══════════════════════════════════════════════════════════════════════════
    val DANGEROUS_PERMISSIONS = mapOf(
        // CRITIQUE - Accès total au système
        "android.permission.BIND_ACCESSIBILITY_SERVICE" to ThreatLevel.CRITICAL,
        "android.permission.BIND_DEVICE_ADMIN" to ThreatLevel.CRITICAL,
        "android.permission.WRITE_SECURE_SETTINGS" to ThreatLevel.CRITICAL,
        "android.permission.MOUNT_UNMOUNT_FILESYSTEMS" to ThreatLevel.CRITICAL,
        "android.permission.INJECT_EVENTS" to ThreatLevel.CRITICAL,
        "android.permission.CAPTURE_AUDIO_OUTPUT" to ThreatLevel.CRITICAL,
        "android.permission.CAPTURE_VIDEO_OUTPUT" to ThreatLevel.CRITICAL,
        "android.permission.READ_FRAME_BUFFER" to ThreatLevel.CRITICAL,
        // HAUT - Espionnage direct
        "android.permission.READ_SMS" to ThreatLevel.HIGH,
        "android.permission.SEND_SMS" to ThreatLevel.HIGH,
        "android.permission.RECEIVE_SMS" to ThreatLevel.HIGH,
        "android.permission.READ_CALL_LOG" to ThreatLevel.HIGH,
        "android.permission.WRITE_CALL_LOG" to ThreatLevel.HIGH,
        "android.permission.PROCESS_OUTGOING_CALLS" to ThreatLevel.HIGH,
        "android.permission.RECORD_AUDIO" to ThreatLevel.HIGH,
        "android.permission.ACCESS_BACKGROUND_LOCATION" to ThreatLevel.HIGH,
        "android.permission.SYSTEM_ALERT_WINDOW" to ThreatLevel.HIGH,
        "android.permission.BIND_NOTIFICATION_LISTENER_SERVICE" to ThreatLevel.HIGH,
        "android.permission.REQUEST_INSTALL_PACKAGES" to ThreatLevel.HIGH,
        "android.permission.READ_PHONE_NUMBERS" to ThreatLevel.HIGH,
        "android.permission.ANSWER_PHONE_CALLS" to ThreatLevel.HIGH,
        "android.permission.CALL_PHONE" to ThreatLevel.HIGH,
        "android.permission.MANAGE_ACCOUNTS" to ThreatLevel.HIGH,
        "android.permission.GET_ACCOUNTS" to ThreatLevel.HIGH,
        "android.permission.USE_CREDENTIALS" to ThreatLevel.HIGH,
        "android.permission.WRITE_SETTINGS" to ThreatLevel.HIGH,
        "android.permission.CHANGE_WIFI_STATE" to ThreatLevel.HIGH,
        "android.permission.BLUETOOTH_ADMIN" to ThreatLevel.HIGH,
        // MOYEN - Collecte de données
        "android.permission.CAMERA" to ThreatLevel.MEDIUM,
        "android.permission.READ_CONTACTS" to ThreatLevel.MEDIUM,
        "android.permission.WRITE_CONTACTS" to ThreatLevel.MEDIUM,
        "android.permission.ACCESS_FINE_LOCATION" to ThreatLevel.MEDIUM,
        "android.permission.ACCESS_COARSE_LOCATION" to ThreatLevel.MEDIUM,
        "android.permission.READ_CALENDAR" to ThreatLevel.MEDIUM,
        "android.permission.WRITE_CALENDAR" to ThreatLevel.MEDIUM,
        "android.permission.READ_EXTERNAL_STORAGE" to ThreatLevel.MEDIUM,
        "android.permission.WRITE_EXTERNAL_STORAGE" to ThreatLevel.MEDIUM,
        "android.permission.READ_PHONE_STATE" to ThreatLevel.MEDIUM,
        "android.permission.PACKAGE_USAGE_STATS" to ThreatLevel.MEDIUM,
        "android.permission.BODY_SENSORS" to ThreatLevel.MEDIUM,
        "android.permission.ACTIVITY_RECOGNITION" to ThreatLevel.MEDIUM
    )
    
    // ══════════════════════════════════════════════════════════════════════════
    // COMBINAISONS CRITIQUES - Patterns typiques des spywares
    // ══════════════════════════════════════════════════════════════════════════
    val CRITICAL_COMBOS = listOf(
        // Exfiltration SMS
        setOf("android.permission.READ_SMS", "android.permission.INTERNET"),
        setOf("android.permission.RECEIVE_SMS", "android.permission.INTERNET"),
        // Exfiltration appels
        setOf("android.permission.READ_CALL_LOG", "android.permission.INTERNET"),
        setOf("android.permission.PROCESS_OUTGOING_CALLS", "android.permission.INTERNET"),
        // Écoute audio
        setOf("android.permission.RECORD_AUDIO", "android.permission.INTERNET"),
        // Surveillance caméra
        setOf("android.permission.CAMERA", "android.permission.INTERNET", "android.permission.RECORD_AUDIO"),
        // Tracking GPS
        setOf("android.permission.ACCESS_FINE_LOCATION", "android.permission.INTERNET", "android.permission.ACCESS_BACKGROUND_LOCATION"),
        // Contrôle total via Accessibility
        setOf("android.permission.BIND_ACCESSIBILITY_SERVICE", "android.permission.INTERNET"),
        setOf("android.permission.BIND_ACCESSIBILITY_SERVICE", "android.permission.SYSTEM_ALERT_WINDOW"),
        // Exfiltration contacts
        setOf("android.permission.READ_CONTACTS", "android.permission.INTERNET"),
        // Keylogger pattern
        setOf("android.permission.BIND_ACCESSIBILITY_SERVICE", "android.permission.RECORD_AUDIO"),
        // Screen capture pattern
        setOf("android.permission.SYSTEM_ALERT_WINDOW", "android.permission.INTERNET"),
        // Device admin abuse
        setOf("android.permission.BIND_DEVICE_ADMIN", "android.permission.INTERNET"),
        // Notification spy
        setOf("android.permission.BIND_NOTIFICATION_LISTENER_SERVICE", "android.permission.INTERNET"),
        // Full surveillance combo
        setOf("android.permission.READ_SMS", "android.permission.READ_CALL_LOG", "android.permission.RECORD_AUDIO", "android.permission.INTERNET")
    )
    
    // ══════════════════════════════════════════════════════════════════════════
    // CHEMINS ROOT ET EXPLOITS - Détection d'accès root cachés
    // ══════════════════════════════════════════════════════════════════════════
    val ROOT_PATHS = arrayOf(
        "/system/app/Superuser.apk", "/sbin/su", "/system/bin/su",
        "/system/xbin/su", "/data/local/xbin/su", "/data/local/bin/su",
        "/system/sd/xbin/su", "/system/bin/failsafe/su", "/data/local/su",
        "/su/bin/su", "/su/bin", "/system/app/SuperSU.apk", "/system/app/SuperSU",
        "/system/app/Magisk.apk", "/sbin/magisk", "/system/xbin/magisk",
        "/data/adb/magisk", "/data/adb/modules", "/cache/magisk.log",
        // KingRoot, KingoRoot
        "/data/data/com.kingroot.kinguser", "/data/data/com.kingo.root",
        // Autres chemins suspects
        "/system/xbin/daemonsu", "/system/etc/init.d/99SuperSUDaemon",
        "/dev/com.koushikdutta.superuser.daemon", "/system/etc/.installed_su_daemon",
        // Busybox (souvent avec root)
        "/system/xbin/busybox", "/system/bin/busybox",
        // Frida (injection)
        "/data/local/tmp/frida-server", "/data/local/tmp/re.frida.server",
        // Xposed
        "/system/framework/XposedBridge.jar", "/system/bin/app_process.orig",
        "/data/data/de.robv.android.xposed.installer"
    )
    
    val ROOT_PACKAGES = arrayOf(
        "com.noshufou.android.su", "com.noshufou.android.su.elite",
        "eu.chainfire.supersu", "com.koushikdutta.superuser",
        "com.thirdparty.superuser", "com.yellowes.su", "com.topjohnwu.magisk",
        "com.kingroot.kinguser", "com.kingo.root", "com.smedialink.oneclickroot",
        "com.zhiqupk.root.global", "com.alephzain.framaroot",
        // Xposed
        "de.robv.android.xposed.installer", "org.meowcat.edxposed.manager",
        "org.lsposed.manager",
        // Frida
        "re.frida.server",
        // Root cloaking
        "com.devadvance.rootcloak", "com.devadvance.rootcloakplus",
        "com.saurik.substrate", "com.zachspong.temprootremovejb",
        "com.amphoras.hidemyroot", "com.amphoras.hidemyrootadfree",
        "com.formyhm.hideroot", "com.formyhm.hiderootpremium"
    )
    
    // ══════════════════════════════════════════════════════════════════════════
    // SERVICES SYSTÈME SUSPECTS - Apps qui se font passer pour le système
    // ══════════════════════════════════════════════════════════════════════════
    val FAKE_SYSTEM_NAMES = setOf(
        "System Service", "System Update", "Android Service", "Google Service",
        "Play Service", "System Manager", "Device Manager", "Battery Optimizer",
        "Memory Cleaner", "Phone Cleaner", "WiFi Manager", "Network Service",
        "Sync Service", "Backup Service", "Update Manager", "Security Service",
        "Android System", "Google Play", "System UI", "Settings Storage",
        "Package Installer", "Download Manager", "Media Storage"
    )
    
    // ══════════════════════════════════════════════════════════════════════════
    // FONCTIONS DE DÉTECTION
    // ══════════════════════════════════════════════════════════════════════════
    
    fun isMalware(pkg: String): Boolean {
        val lower = pkg.lowercase()
        return KNOWN_MALWARE.any { lower.contains(it.lowercase()) }
    }
    
    fun isSpyware(pkg: String): Boolean {
        val lower = pkg.lowercase()
        return KNOWN_SPYWARE.any { lower.contains(it.lowercase()) }
    }
    
    fun isFakeParentalControl(pkg: String): Boolean {
        val lower = pkg.lowercase()
        return FAKE_PARENTAL_CONTROLS.any { lower.contains(it.lowercase()) }
    }
    
    fun isAdware(pkg: String): Boolean {
        val lower = pkg.lowercase()
        return KNOWN_ADWARE.any { lower.contains(it.lowercase()) }
    }
    
    fun isSuspicious(pkg: String): Boolean {
        return SUSPICIOUS_PATTERNS.any { it.matches(pkg) }
    }
    
    fun isFakeSystemApp(appName: String): Boolean {
        val lower = appName.lowercase()
        return FAKE_SYSTEM_NAMES.any { lower.contains(it.lowercase()) }
    }
    
    fun hasCriticalCombo(perms: Set<String>): Boolean {
        return CRITICAL_COMBOS.any { combo -> combo.all { perms.contains(it) } }
    }
    
    fun hasSpywarePermissionPattern(perms: List<String>): Boolean {
        val permSet = perms.toSet()
        val hasInternet = permSet.contains("android.permission.INTERNET")
        if (!hasInternet) return false
        
        val spyPerms = listOf(
            "android.permission.READ_SMS",
            "android.permission.RECORD_AUDIO",
            "android.permission.READ_CALL_LOG",
            "android.permission.ACCESS_FINE_LOCATION",
            "android.permission.CAMERA",
            "android.permission.READ_CONTACTS",
            "android.permission.BIND_ACCESSIBILITY_SERVICE"
        )
        
        val spyCount = spyPerms.count { permSet.contains(it) }
        return spyCount >= 3
    }
    
    fun calculatePermissionRisk(perms: List<String>): Int {
        var score = 0
        val permSet = perms.toSet()
        
        perms.forEach { p ->
            when (DANGEROUS_PERMISSIONS[p]) {
                ThreatLevel.CRITICAL -> score += 25
                ThreatLevel.HIGH -> score += 15
                ThreatLevel.MEDIUM -> score += 8
                ThreatLevel.LOW -> score += 3
                else -> {}
            }
        }
        
        if (hasCriticalCombo(permSet)) score += 30
        if (hasSpywarePermissionPattern(perms)) score += 25
        
        return score.coerceAtMost(100)
    }
    
    fun getThreatCategory(pkg: String, appName: String, perms: List<String>): String? {
        return when {
            isMalware(pkg) -> "MALWARE"
            isSpyware(pkg) -> "SPYWARE"
            isFakeParentalControl(pkg) -> "FAKE_PARENTAL_CONTROL"
            isAdware(pkg) -> "ADWARE"
            isSuspicious(pkg) -> "SUSPICIOUS"
            isFakeSystemApp(appName) -> "FAKE_SYSTEM"
            hasSpywarePermissionPattern(perms) -> "SPYWARE_PATTERN"
            else -> null
        }
    }
}
